<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador Completo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>

    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-top: 30px; }
        .main-card { max-width: 700px; margin: auto; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); background: white; padding: 30px; }
        .log-box { background: #2d2d2d; color: #00ff00; font-family: monospace; padding: 10px; border-radius: 5px; font-size: 12px; height: 100px; overflow-y: scroll; margin-top: 15px; display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <h2 class="text-center text-primary mb-4">Validador de Facturas</h2>
        
        <div class="alert alert-info">
            <small>‚ÑπÔ∏è El sistema buscar√°: "NIT", "FACTURA" y firma.</small>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">1. Selecciona tu imagen:</label>
            <input type="file" id="inputImagen" class="form-control" accept="image/*">
        </div>

        <button onclick="iniciarEscaneo()" class="btn btn-primary w-100 py-2 fw-bold" id="btnAccion">
            üîç Validar Documento Ahora
        </button>

        <div id="cajaLog" class="log-box">
            <div>> Esperando instrucciones...</div>
        </div>

        <div id="zonaResultados" class="hidden mt-4">
            <div id="alertaFinal" class="alert" role="alert">
                <h4 id="tituloRes" class="alert-heading">Resultados</h4>
                <hr>
                <ul id="listaErrores" class="mb-0"></ul>
            </div>
            
            <div class="accordion mt-3" id="accordionText">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseText">
                            Ver texto que ley√≥ el robot
                        </button>
                    </h2>
                    <div id="collapseText" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <pre id="textoCrudo" style="white-space: pre-wrap; font-size: 11px; background: #eee; padding: 10px;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // Funci√≥n para escribir en la cajita negra de log
    function log(mensaje) {
        const caja = document.getElementById('cajaLog');
        caja.style.display = 'block';
        const linea = document.createElement('div');
        linea.innerText = "> " + mensaje;
        caja.appendChild(linea);
        caja.scrollTop = caja.scrollHeight; // Auto scroll al final
    }

    async function iniciarEscaneo() {
        const input = document.getElementById('inputImagen');
        const btn = document.getElementById('btnAccion');
        const zonaResultados = document.getElementById('zonaResultados');
        
        // Limpiar estados previos
        zonaResultados.classList.add('hidden');
        document.getElementById('cajaLog').innerHTML = ''; 
        
        if (input.files.length === 0) {
            alert("Por favor selecciona una imagen primero");
            return;
        }

        const imagen = input.files[0];
        btn.disabled = true;
        btn.innerText = "Procesando...";

        try {
            log("Iniciando motor Tesseract...");
            
            // LECTURA
            const { data: { text } } = await Tesseract.recognize(
                imagen,
                'spa', // Idioma espa√±ol
                { 
                    logger: m => {
                        // Solo mostramos el progreso relevante
                        if(m.status === 'recognizing text') {
                            log(`Leyendo texto: ${(m.progress * 100).toFixed(0)}%`);
                        } else {
                            log(m.status);
                        }
                    }
                }
            );

            log("¬°Lectura finalizada!");
            procesarReglas(text);

        } catch (error) {
            log("ERROR CR√çTICO: " + error.message);
            console.error(error);
            alert("Fall√≥ la lectura. Revisa la cajita negra para ver el error.");
        } finally {
            btn.disabled = false;
            btn.innerText = "üîç Validar Documento Ahora";
        }
    }

    function procesarReglas(texto) {
        const zonaResultados = document.getElementById('zonaResultados');
        const alertaFinal = document.getElementById('alertaFinal');
        const listaErrores = document.getElementById('listaErrores');
        const tituloRes = document.getElementById('tituloRes');
        const textoCrudo = document.getElementById('textoCrudo');

        zonaResultados.classList.remove('hidden');
        textoCrudo.innerText = texto;
        listaErrores.innerHTML = "";

        const textoMayus = texto.toUpperCase();
        let errores = [];

        // REGLAS DE NEGOCIO
        if (!textoMayus.includes("NIT") && !textoMayus.includes("RUT")) {
            errores.push("‚ùå Falta NIT o RUT");
        }
        if (!textoMayus.includes("FACTURA") && !textoMayus.includes("CUENTA DE COBRO")) {
            errores.push("‚ùå No dice 'Factura' ni 'Cuenta de Cobro'");
        }
        // B√∫squeda de firma m√°s flexible
        if (!textoMayus.includes("FIRMA") && 
            !textoMayus.includes("ATENTAMENTE") && 
            !textoMayus.includes("CORDIALMENTE") &&
            !textoMayus.includes("RECIBIDO")) {
            errores.push("‚ùå No se detecta firma o remitente");
        }

        // MOSTRAR VEREDICTO
        if (errores.length > 0) {
            alertaFinal.className = "alert alert-danger";
            tituloRes.innerText = "Documento Rechazado üòû";
            errores.forEach(e => {
                let li = document.createElement('li');
                li.innerText = e;
                listaErrores.appendChild(li);
            });
        } else {
            alertaFinal.className = "alert alert-success";
            tituloRes.innerText = "Documento Aprobado ‚úÖ";
            let li = document.createElement('li');
            li.innerText = "Cumple con NIT, T√≠tulo y Firma.";
            listaErrores.appendChild(li);
        }
    }
</script>

</body>
</html>